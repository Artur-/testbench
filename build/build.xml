<?xml version="1.0"?>

<project name="Testbench build" basedir="." default="testbench-distribution-package">
	<tstamp />
	<property name="timestamp" value="${DSTAMP}${TSTAMP}" />
	<property name="version" value="2.0.0.development.${timestamp}" />
	<property name="output.dir" value="result/package" />

	<target name="testbench.jar">
		<delete dir="result" failonerror="false" />

		<mkdir dir="${output.dir}" />
		<mkdir dir="result/classes" />
		<javac srcdir="../src" destdir="result/classes">
			<classpath>
				<fileset dir="../lib" id="libs">
					<include name="*.jar" />
				</fileset>

			</classpath>
		</javac>
		<jar jarfile="${output.dir}/vaadin-testbench-${version}.jar" compress="true">
			<manifest>
				<attribute name="Class-Path" value="junit-4.5.jar selenium-java-client-driver.jar js.jar" />
			</manifest>
			<zipfileset dir="../src">
				<include name="**/**.js" />
			</zipfileset>
			<zipfileset dir="result/classes">
				<include name="**/**" />
			</zipfileset>
			<zipfileset src="../lib/commons-io-1.1.jar" />
			<zipfileset src="../lib/commons-codec-1.4.jar" />
			<zipfileset src="../lib/js.jar" />
			<zipfileset src="../lib/junit-4.5.jar" />
			<zipfileset src="../lib/selenium-java-client-driver.jar" />
		</jar>
	</target>
	
	<target name="testbench-ide">
		<!-- Create the Testbench IDE FireFox plugin -->
		<subant target="extension">
			<property name="version" value="${timestamp}"/>
			<fileset dir="../testbench-ide" includes="build.xml" />
		</subant>
		<copy file="../testbench-ide/extension/Testbench-ide-${timestamp}.xpi" todir="${output.dir}/testbench-ide" />
	</target>

	<target name="testbench-grid">
		<subant target="dist">
			<property name="timestamp" value="${timestamp}"/>
			<fileset dir="../testbench-grid/infrastructure/core" includes="build.xml" />
		</subant>
		<subant target="package-standalone">
			<property name="timestamp" value="${timestamp}"/>
			<fileset dir="../testbench-grid/infrastructure/webserver" includes="build.xml" />
		</subant>
		<parallel>
			<subant target="package-standalone">
				<property name="timestamp" value="${timestamp}"/>
				<fileset dir="../testbench-grid/hub" includes="build.xml" />
			</subant>
			<subant target="package-standalone">
				<property name="timestamp" value="${timestamp}"/>
				<fileset dir="../testbench-grid/remote-control" includes="build.xml" />
			</subant>
		</parallel>
		<parallel>
			<subant target="clean-classes">
				<fileset dir="../testbench-grid/infrastructure/core" includes="build.xml" />
			</subant>
			<subant target="clean-classes">
				<fileset dir="../testbench-grid/infrastructure/webserver" includes="build.xml" />
			</subant>
		</parallel>
	</target>
	
	<target name="testbench-distribution-package" depends="testbench.jar,testbench-ide,testbench-grid,update-run-scripts">
		<zip destfile="${output.dir}/vaadin-testbench-${version}.zip">
			<zipfileset dir="${output.dir}" includes="vaadin-testbench-${version}.jar" />
			<zipfileset dir="${output.dir}" includes="testbench-ide/Testbench-ide-${timestamp}.xpi"  />
<!--			<zipfileset dir=".." includes="selenium-extensions/**" />-->
			<!-- Not certain about MPL or CPL licenses -->
<!--			<fileset dir=".." includes="lib/js.jar lib/junit*.jar" excludes="lib/**-source* lib/**-src*" />-->
			<zipfileset dir=".." includes="example/test.xml" />
			<zipfileset dir=".." includes="example/testscripts/*.html" />
			<!-- Add documentation -->
			<zipfileset dir="../doc" includes="*.pdf" prefix="documentation" />
<!--			<fileset dir=".." includes="example/tests/**" />-->
			<!-- Add hub and remote-control to zip -->
			<zipfileset dir="../testbench-grid/hub" includes="hub hub.bat grid_configuration.yml" prefix="grid/hub" />
			<zipfileset dir="../testbench-grid/hub/target/dist/lib" includes="**standalone*.jar" prefix="grid/hub/lib" />
			
			<zipfileset dir="../testbench-grid/remote-control" includes="rc rc.bat" prefix="grid/remote-control" />
			<zipfileset dir="../testbench-grid/remote-control/target/dist/lib" includes="**standalone*.jar" prefix="grid/remote-control/lib" />
			<zipfileset dir="../testbench-grid/vendor" includes="selenium-server*.jar" prefix="grid/remote-control/lib" />
			<zipfileset dir="../selenium-extensions/core" includes="user-extensions.js" prefix="grid/remote-control" />
		</zip>
			
		<zip destfile="${output.dir}/vaadin-testbench-grid-${timestamp}.zip">
			<zipfileset dir="../testbench-grid/hub" includes="hub hub.bat grid_configuration.yml" prefix="hub" />
			<zipfileset dir="../testbench-grid/hub/target/dist/lib" includes="**standalone*.jar" prefix="hub/lib" />
			
			<zipfileset dir="../testbench-grid/remote-control" includes="rc rc.bat" prefix="remote-control" />
			<zipfileset dir="../testbench-grid/remote-control/target/dist/lib" includes="**standalone*.jar" prefix="remote-control/lib" />
			<zipfileset dir="../testbench-grid/vendor" includes="selenium-server*.jar" prefix="remote-control/lib" />
			<zipfileset dir="../selenium-extensions/core" includes="user-extensions.js" prefix="remote-control" />
		</zip>
	</target>

	<!-- Creates script files for starting hub and remote-control -->
	<target name="update-run-scripts">
		<copy file="../testbench-grid/hub/hub.tpl" tofile="../testbench-grid/hub/hub" overwrite="true">
					<filterchain>
						<replacetokens>
							<token key="build" value="${timestamp}" />
						</replacetokens>
					</filterchain>
		</copy>
		<copy file="../testbench-grid/hub/hub.bat_tpl" tofile="../testbench-grid/hub/hub.bat" overwrite="true">
					<filterchain>
						<replacetokens>
							<token key="build" value="${timestamp}" />
						</replacetokens>
					</filterchain>
		</copy>
		<copy file="../testbench-grid/remote-control/rc.tpl" tofile="../testbench-grid/remote-control/rc" overwrite="true">
					<filterchain>
						<replacetokens>
							<token key="build" value="${timestamp}" />
						</replacetokens>
					</filterchain>
		</copy>
		<copy file="../testbench-grid/remote-control/rc.bat_tpl" tofile="../testbench-grid/remote-control/rc.bat" overwrite="true">
					<filterchain>
						<replacetokens>
							<token key="build" value="${timestamp}" />
						</replacetokens>
					</filterchain>
		</copy>
	</target>
		
</project>
